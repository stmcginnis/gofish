//
// SPDX-License-Identifier: BSD-3-Clause
//

package redfish

import (
	"encoding/json"

	"github.com/stmcginnis/gofish/common"
)

// MetricReport shall represent a metric report in a Redfish implementation. When a metric report is deleted, the
// historic metric data used to generate the report shall be deleted as well unless other metric reports are
// consuming the data.
type MetricReport struct {
	common.Entity
	// ODataContext is the odata context.
	ODataContext string `json:"@odata.context"`
	// ODataEtag is the odata etag.
	ODataEtag string `json:"@odata.etag"`
	// ODataType is the odata type.
	ODataType string `json:"@odata.type"`
	// Context shall contain a client supplied context for the event destination to which this event is being sent.
	// This property shall only be present when sent as a payload in an event.
	Context string
	// Description provides a description of this resource.
	Description string
	// MetricReportDefinition shall contain a link to a resource of type MetricReportDefinition.
	metricReportDefinition string
	// MetricValues shall be metric values for this metric report.
	MetricValues []MetricValue
	// Oem shall contain the OEM extensions. All values for properties that this object contains shall conform to the
	// Redfish Specification-described requirements.
	OEM json.RawMessage `json:"Oem"`
	// Timestamp shall contain the time when the metric report was generated.
	Timestamp string
}

// UnmarshalJSON unmarshals a MetricReport object from the raw JSON.
func (metricreport *MetricReport) UnmarshalJSON(b []byte) error {
	type temp MetricReport
	var t struct {
		temp
		MetricReportDefinition common.Link
	}

	err := json.Unmarshal(b, &t)
	if err != nil {
		return err
	}

	*metricreport = MetricReport(t.temp)

	// Extract the links to other entities for later
	metricreport.metricReportDefinition = t.MetricReportDefinition.String()

	return nil
}

// MetricReportDefinition gets the definition for this metric
func (metricreport *MetricReport) MetricReportDefinition() (*MetricReportDefinition, error) {
	if metricreport.metricReportDefinition == "" {
		return nil, nil
	}

	return GetMetricReportDefinition(metricreport.GetClient(), metricreport.metricReportDefinition)
}

// GetMetricReport will get a MetricReport instance from the service.
func GetMetricReport(c common.Client, uri string) (*MetricReport, error) {
	resp, err := c.Get(uri)
	if err != nil {
		return nil, err
	}
	defer resp.Body.Close()

	var metricreport MetricReport
	err = json.NewDecoder(resp.Body).Decode(&metricreport)
	if err != nil {
		return nil, err
	}

	metricreport.SetClient(c)
	return &metricreport, nil
}

// ListReferencedMetricReports gets the collection of MetricReport from
// a provided reference.
func ListReferencedMetricReports(c common.Client, link string) ([]*MetricReport, error) {
	var result []*MetricReport
	if link == "" {
		return result, nil
	}

	type GetResult struct {
		Item  *MetricReport
		Link  string
		Error error
	}

	ch := make(chan GetResult)
	collectionError := common.NewCollectionError()
	get := func(link string) {
		metricreport, err := GetMetricReport(c, link)
		ch <- GetResult{Item: metricreport, Link: link, Error: err}
	}

	go func() {
		err := common.CollectList(get, c, link)
		if err != nil {
			collectionError.Failures[link] = err
		}
		close(ch)
	}()

	for r := range ch {
		if r.Error != nil {
			collectionError.Failures[r.Link] = r.Error
		} else {
			result = append(result, r.Item)
		}
	}

	if collectionError.Empty() {
		return result, nil
	}

	return result, collectionError
}

// MetricValue shall contain properties that capture a metric value and other associated information.
type MetricValue struct {
	// MetricID shall contain the value of the ID property of the MetricDefinition resource that contains additional
	// information for the source metric.
	MetricID string
	// MetricProperty shall contain a URI following RFC6901-specified JSON pointer notation to the property from which
	// this metric is derived. The value of MetricValue may contain additional calculations performed on the property
	// based upon the configuration of the MetricReportDefinition.
	MetricProperty string
	// MetricValue shall contain the metric value, as a string.
	MetricValue string
	// Oem shall contain the OEM extensions. All values for properties contained in this object shall conform to the
	// Redfish Specification-described requirements.
	OEM json.RawMessage `json:"Oem"`
	// Timestamp shall time when the metric value was obtained. Note that this value may be different from the time
	// when this instance is created.
	Timestamp string
}
